---
title: "Nanorod Python test"
author: "Ruth Kristianingsih"
output: no
---

# Initial set-up

```{r setup, message=FALSE, include=FALSE}
devtools::load_all()
library(tidyverse)
theme_set(theme_light())
```


```{r}
virtualenv_dir <- Sys.getenv("VIRTUALENV_NAME")
python_path <- Sys.getenv("PYTHON_PATH")

# Create virtual env and install dependencies
reticulate::use_python(python_path, required = TRUE)
# reticulate::virtualenv_create(envname = virtualenv_dir, python = python_path)
# reticulate::virtualenv_install(virtualenv_dir, packages = PYTHON_DEPENDENCIES, ignore_installed=TRUE)
reticulate::use_virtualenv(virtualenv_dir, required = TRUE)

# Load Python code
reticulate::source_python(app_sys("python/electron_microscopy.py"))
skimage <- reticulate::import("skimage")
# plt <- reticulate::import("matplotlib.pyplot")
```

```{r}
image_path <- app_sys("extdata/1-2_dilution__45kX__JR__0004.dm4")

dm4_list <- open_DM4(image_path)
names(dm4_list) <- c("filename", "img", "pixel_size")
```

```{r}
binary <- img_prep(dm4_list$img) # Prepares the image to be labelled.
labels <- watershedding(binary) # Watersheds and labels the image.
labels <- filter_labels_by_area(labels, 500, dm4_list$pixel_size)
labels <- filter_labels_by_minor_axis_length(labels, 40, dm4_list$pixel_size)
labels <- reorder_labels(labels)
```

```{r}
labels_properties <- skimage$measure$regionprops(labels)
labels_properties <- labels_properties %>% 
  create_length_prop(pixel_size = dm4_list$pixel_size)
```

```{r}
labels_properties %>% 
  purrr::map(
    ~ .x$length
  ) %>% 
  purrr::reduce(c)
```

```{r}
labels_properties %>% sapply(FUN = function(x) x$length)# %>% unlist()
```


# Table 

```{r}
# Creates a table containing the nanorod properties.
table <- skimage$measure$regionprops_table(labels, properties = c('label', 'centroid', 'area'))
table <- as.data.frame(table)

table <- table %>%
  dplyr::mutate(
    # feret_diameter_max = dm4_list$pixel_size * feret_diameter_max,
    image_name = paste0(dm4_list$filename, ".dm4")
  ) %>%
  # dplyr::select(
  #   "Nanorod ID" = label,
  #   "Image name" = image_name,
  #   "Coordinate in Y" = centroid.0,
  #   "Coordinate in X" = centroid.1,
  #   "Length in nm" = feret_diameter_max
  # )
  #  dplyr::select(
  #   Nanorod_ID = label,
  #   image_name,
  #   coord_x = centroid.0,
  #   coord_y = centroid.1,
  #   length_in_nm = feret_diameter_max
  # )
  dplyr::mutate(
    area = dm4_list$pixel_size * dm4_list$pixel_size * area,
    length_in_nm = labels_properties %>% purrr::map(~ .x$length) %>% purrr::reduce(c)
  ) %>%
  dplyr::select(
    Nanorod_ID = label,
    image_name,
    coord_x = centroid.0,
    coord_y = centroid.1,
    length_in_nm,
    area
  )
```

```{r}
# table %>% 
#   data.table::fwrite(here::here("inst/extdata", "nanorod_data_test.csv"))
```



# Plots

## Matplotlib

```{r}
# Plots and saves the images
plot <- plotfig(labels, labels_properties, dm4_list$img, dm4_list$filename, out_dpi = 96)
```

```{r}
temp_img_path <- tempdir()
plotfig_separate(labels, labels_properties, dm4_list$img, paste0(temp_img_path, "/", dm4_list$filename))
```

```{r}
raw_path <- paste0(temp_img_path, "/", dm4_list$filename, "_raw.png")
proc_path <- paste0(temp_img_path, "/", dm4_list$filename, "_processed.png")
```

```{r}
knitr::include_graphics(raw_path)
```

```{r}
px_trans <- function() {
  scales::trans_new(
    "px_trans", 
    function(x) x * px_to / px_from, 
    function(x) x * px_to / px_from
  )
}

raw_img <- magick::image_read(raw_path)
proc_img <- magick::image_read(proc_path)
px_to <- dim(dm4_list$img)[[1]]

list(
  raw_img %>%
    magick::image_resize(paste0(px_to, "x", px_to)) %>%
    magick::image_ggplot() +
    ggplot2::theme_bw() +
    ggplot2::labs(title = "Original image", x = NULL, y = NULL),
  proc_img %>%
    magick::image_resize(paste0(px_to, "x", px_to)) %>%
    magick::image_ggplot() +
    ggplot2::theme_bw() +
    ggplot2::labs(title = "Selected objects", x = NULL, y = NULL)
) %>%
  patchwork::wrap_plots()
```

```{r}
px_from <- magick::image_info(proc_img)$height
px_to <- dim(dm4_list$img)[[1]]

proc_img %>%
  magick::image_resize(paste0(px_to, "x", px_to)) %>%
  magick::image_ggplot() +
  ggplot2::theme_bw() +
  ggplot2::labs(title = "Selected objects", x = NULL, y = NULL) +
  ggplot2::scale_y_continuous(
    # breaks = function(x) x * px_to / px_from,
    # labels = function(x) x * px_to / px_from
    # trans = "px",
    # expand = c(0, 0)
  )
```



## Native R

```{r}
rotate <- function(x) {
  t(apply(x, 2, rev))
}
```


```{r fig.width=5, fig.height=5}
graphics::image(rotate(labels), useRaster=TRUE, axes=FALSE)
```

```{r fig.width=5, fig.height=5}
graphics::image(rotate(dm4_list$img), useRaster=TRUE, axes=FALSE, col = grey(seq(0, 1, length = 256)))
```


```{r}
# raw_mat <- dm4_list$img %>% 
#   # rotate() %>% 
#   as.data.frame() %>% 
#   tibble::rowid_to_column(var = "x") %>% 
#   pivot_longer(
#     cols = -x,
#     names_to = "y"
#   ) %>% 
#     dplyr::mutate(
#       y = stringr::str_remove_all(y, "V") %>% 
#         as.numeric()
#     )
# 
# raw_mat %>% 
#   # dplyr::filter(
#   #   x >= 3500,
#   #   y >= 3500
#   # ) %>% 
# ggplot() +
#   aes(x = x, y = y, fill = value, color = NULL) +
#   geom_tile() +
#   scale_y_continuous(trans = "reverse")
```


